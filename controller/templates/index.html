<!DOCTYPE html>
<html lang="en" class="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Proactive Noisy Neighbor Mitigation</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&display=swap');
        body { background: linear-gradient(135deg, #0f172a 0%, #1e1b4b 100%); color: white; font-family: 'Inter', sans-serif; min-height: 100vh; }
        .glass-panel { background: rgba(30, 41, 59, 0.7); backdrop-filter: blur(10px); border: 1px solid rgba(255, 255, 255, 0.1); box-shadow: 0 8px 32px 0 rgba(0, 0, 0, 0.37); }
        .glow-text { text-shadow: 0 0 10px rgba(96, 165, 250, 0.5); }
    </style>
</head>
<body class="p-6 md:p-10">

    <div class="max-w-7xl mx-auto space-y-8">
        
        <header class="flex flex-col md:flex-row justify-between items-center glass-panel p-6 rounded-2xl">
            <div>
                <h1 class="text-3xl font-bold text-blue-400 glow-text">üõ°Ô∏è AI Resource Controller</h1>
                <p class="text-slate-400 mt-2 text-sm uppercase tracking-wider">Live Noisy Neighbor Mitigation Dashboard</p>
            </div>
            <div id="status-badge" class="mt-4 md:mt-0 px-6 py-3 rounded-full font-bold text-lg transition-all duration-300 shadow-lg">
                CONNECTING...
            </div>
        </header>

        <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
            <div class="glass-panel p-6 rounded-2xl relative overflow-hidden group">
                <div class="absolute top-0 right-0 p-4 opacity-10 group-hover:opacity-20 transition-opacity">
                    <svg class="w-16 h-16 text-blue-400" fill="currentColor" viewBox="0 0 20 20"><path d="M13 7H7v6h6V7z"/><path fill-rule="evenodd" d="M5 3a2 2 0 00-2 2v10a2 2 0 002 2h10a2 2 0 002-2V5a2 2 0 00-2-2H5zm12 2v10H3V5h14z" clip-rule="evenodd"/></svg>
                </div>
                <h3 class="text-slate-400 text-sm font-semibold mb-2 uppercase tracking-wide">CPU Utilization</h3>
                <div class="flex items-end gap-2">
                    <p class="text-5xl font-bold text-blue-400" id="current-cpu">0</p>
                    <span class="text-xl text-slate-500 mb-1">%</span>
                </div>
            </div>

            <div class="glass-panel p-6 rounded-2xl relative overflow-hidden group">
                <div class="absolute top-0 right-0 p-4 opacity-10 group-hover:opacity-20 transition-opacity">
                    <svg class="w-16 h-16 text-purple-400" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M3 5a2 2 0 012-2h10a2 2 0 012 2v10a2 2 0 01-2 2H5a2 2 0 01-2-2V5zm11 1H6v8l4-2 4 2V6z" clip-rule="evenodd"/></svg>
                </div>
                <h3 class="text-slate-400 text-sm font-semibold mb-2 uppercase tracking-wide">Memory Utilization</h3>
                <div class="flex items-end gap-2">
                    <p class="text-5xl font-bold text-purple-400" id="current-mem">0</p>
                    <span class="text-xl text-slate-500 mb-1">%</span>
                </div>
            </div>

            <div class="glass-panel p-6 rounded-2xl relative overflow-hidden group">
                <div class="absolute top-0 right-0 p-4 opacity-10 group-hover:opacity-20 transition-opacity">
                    <svg class="w-16 h-16 text-red-400" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm1-12a1 1 0 10-2 0v4a1 1 0 00.293.707l2.828 2.829a1 1 0 101.415-1.415L11 9.586V6z" clip-rule="evenodd"/></svg>
                </div>
                <h3 class="text-slate-400 text-sm font-semibold mb-2 uppercase tracking-wide">Service Latency</h3>
                <div class="flex items-end gap-2">
                    <p class="text-5xl font-bold text-red-400" id="current-lat">0</p>
                    <span class="text-xl text-slate-500 mb-1">ms</span>
                </div>
            </div>
        </div>

        <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
            
            <div class="glass-panel p-6 rounded-2xl lg:col-span-2">
                <h3 class="text-xl font-bold mb-4 text-slate-200">üìà Live Resource Timeline</h3>
                <canvas id="timelineChart" height="120"></canvas>
            </div>

            <div class="glass-panel p-6 rounded-2xl">
                <h3 class="text-xl font-bold mb-4 text-slate-200">‚öñÔ∏è Before vs. After Mitigation</h3>
                <p class="text-xs text-slate-400 mb-4">Compares peak noisy neighbor chaos to the current stabilized state.</p>
                <canvas id="comparisonChart" height="200"></canvas>
            </div>
        </div>
    </div>

    <script>
        // --- 1. Common Chart Config ---
        Chart.defaults.color = '#94a3b8';
        Chart.defaults.font.family = 'Inter';

        // --- 2. Live Timeline Chart Setup ---
        const timelineCtx = document.getElementById('timelineChart').getContext('2d');
        const timelineChart = new Chart(timelineCtx, {
            type: 'line',
            data: { 
                labels: [], 
                datasets: [
                    { label: 'CPU (%)', borderColor: '#3b82f6', backgroundColor: 'rgba(59, 130, 246, 0.1)', borderWidth: 3, tension: 0.4, fill: true, data: [] },
                    { label: 'Memory (%)', borderColor: '#a855f7', backgroundColor: 'rgba(168, 85, 247, 0.1)', borderWidth: 3, tension: 0.4, fill: true, data: [] },
                    { label: 'Latency (ms / 10)', borderColor: '#ef4444', backgroundColor: 'rgba(239, 68, 68, 0.1)', borderWidth: 3, tension: 0.4, fill: true, data: [] } // Scaled latency for visual fit
                ] 
            },
            options: {
                responsive: true,
                animation: { duration: 0 }, // Disable animation for smoother live scrolling
                scales: {
                    x: { grid: { color: 'rgba(255,255,255,0.05)' } },
                    y: { grid: { color: 'rgba(255,255,255,0.05)' }, beginAtZero: true }
                },
                plugins: { legend: { position: 'top' } }
            }
        });

        // --- 3. Before & After Comparison Chart Setup ---
        const compCtx = document.getElementById('comparisonChart').getContext('2d');
        const comparisonChart = new Chart(compCtx, {
            type: 'bar',
            data: {
                labels: ['CPU (%)', 'Memory (%)', 'Latency (ms)'],
                datasets: [
                    {
                        label: 'Before (Peak Spike)',
                        backgroundColor: 'rgba(239, 68, 68, 0.8)', // Red
                        borderRadius: 4,
                        data: [0, 0, 0]
                    },
                    {
                        label: 'After (Current)',
                        backgroundColor: 'rgba(34, 197, 94, 0.8)', // Green
                        borderRadius: 4,
                        data: [0, 0, 0]
                    }
                ]
            },
            options: {
                responsive: true,
                scales: {
                    y: { grid: { color: 'rgba(255,255,255,0.05)' }, beginAtZero: true }
                },
                plugins: { legend: { position: 'bottom' } }
            }
        });

        // --- Logic to track peak chaos for the "Before" chart ---
        let peakCpu = 0;
        let peakMem = 0;
        let peakLat = 0;

        async function updateDashboard() {
            try {
                const res = await fetch('/api/data');
                const data = await res.json();

                if(data.timestamps.length === 0) return;

                const lastIdx = data.timestamps.length - 1;
                const currentCpu = data.cpu[lastIdx];
                const currentMem = data.memory[lastIdx];
                const currentLat = data.latency[lastIdx];
                const currentState = data.states[lastIdx];

                // Update Live Values
                document.getElementById('current-cpu').innerText = currentCpu.toFixed(1);
                document.getElementById('current-mem').innerText = currentMem.toFixed(1);
                document.getElementById('current-lat').innerText = currentLat.toFixed(0);

                // Update Status Badge
                const badge = document.getElementById('status-badge');
                if(currentState === 'NORMAL' || currentState === '') {
                    badge.className = 'px-6 py-3 rounded-full font-bold text-sm bg-green-500/20 text-green-400 border border-green-500 shadow-[0_0_15px_rgba(34,197,94,0.3)]';
                    badge.innerHTML = '‚úÖ SYSTEM NORMAL';
                } else {
                    badge.className = 'px-6 py-3 rounded-full font-bold text-sm bg-red-500/20 text-red-400 border border-red-500 animate-pulse shadow-[0_0_15px_rgba(239,68,68,0.5)]';
                    badge.innerHTML = '‚ö†Ô∏è MITIGATING: ' + currentState;
                    
                    // IF THERE IS A SPIKE, RECORD THE PEAK VALUES FOR THE "BEFORE" GRAPH
                    if(currentCpu > peakCpu) peakCpu = currentCpu;
                    if(currentMem > peakMem) peakMem = currentMem;
                    if(currentLat > peakLat) peakLat = currentLat;
                }

                // Update Live Timeline Chart
                timelineChart.data.labels = data.timestamps;
                timelineChart.data.datasets[0].data = data.cpu;
                timelineChart.data.datasets[1].data = data.memory;
                // Divide latency by 10 so it fits nicely on the same axis as CPU/Memory percentages
                timelineChart.data.datasets[2].data = data.latency.map(l => l / 10); 
                timelineChart.update();

                // Update Before/After Comparison Chart
                // Dataset 0 is "Before" (The recorded peaks)
                comparisonChart.data.datasets[0].data = [peakCpu, peakMem, peakLat / 10]; 
                // Dataset 1 is "After" (The current mitigated state)
                comparisonChart.data.datasets[1].data = [currentCpu, currentMem, currentLat / 10];
                comparisonChart.update();

            } catch (error) {
                console.error("Error fetching data:", error);
            }
        }

        setInterval(updateDashboard, 2000); // Refresh every 2 seconds
        updateDashboard();
    </script>
</body>
</html>